<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MyTek Juwaidy - Sistem Tugasan Juruteknik</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- FileSaver.js untuk simpan fail -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* Backdrop dengan tema Malaysia dan AI */
        body {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.9) 0%, rgba(4, 120, 87, 0.95) 100%),
                        url('https://images.unsplash.com/photo-1589739900243-4b52cd9dd8df?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 16px;
            position: relative;
        }

        /* Overlap dengan corak Malaysia */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.05) 0px,
                rgba(255, 255, 255, 0.05) 20px,
                rgba(255, 215, 0, 0.02) 20px,
                rgba(255, 215, 0, 0.02) 40px
            );
            pointer-events: none;
            z-index: 1;
        }

        /* Pattern Jalur Gemilang halus */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                rgba(255, 0, 0, 0.02) 0%,
                rgba(255, 255, 255, 0.02) 50%,
                rgba(0, 0, 255, 0.02) 100%
            );
            pointer-events: none;
            z-index: 1;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        .app-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 24px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* Logo Malaysia dan AI di header */
        .app-header::before {
            content: "üá≤üáæ";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            opacity: 0.2;
            animation: float 3s ease-in-out infinite;
        }

        .app-header::after {
            content: "ü§ñ";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            opacity: 0.2;
            animation: float 3s ease-in-out infinite reverse;
        }

        @keyframes float {
            0% { transform: translateY(-50%) translateX(0); }
            50% { transform: translateY(-60%) translateX(10px); }
            100% { transform: translateY(-50%) translateX(0); }
        }

        .app-header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .app-header h1 i {
            color: #FFD700;
            text-shadow: 0 0 10px rgba(255,215,0,0.5);
        }

        .app-header p {
            opacity: 0.9;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }

        .content {
            padding: 20px;
            position: relative;
            z-index: 3;
        }

        /* Tab Navigation */
        .tab-bar {
            display: flex;
            background: #f3f4f6;
            border-radius: 12px;
            margin-bottom: 20px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #4b5563;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            background: #f9fafb;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #10b981;
            background: white;
        }

        /* Camera Section */
        .camera-container {
            background: #f3f4f6;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #10b981;
        }

        .camera-preview {
            width: 100%;
            height: 300px;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        #photoPreview {
            max-width: 100%;
            max-height: 300px;
            display: none;
            border-radius: 12px;
        }

        .camera-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .camera-btn {
            flex: 1;
            min-width: 120px;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .camera-btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }

        .btn-save {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Filter Section */
        .filter-section {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .filter-title {
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            flex: 1;
            min-width: 120px;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            background: white;
        }

        .filter-btn {
            padding: 12px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover {
            background: #047857;
        }

        /* Status Filter Buttons */
        .status-filter {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .status-filter-btn {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            color: #4b5563;
            border: 2px solid #e5e7eb;
        }

        .status-filter-btn.active {
            transform: scale(1.02);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .status-filter-btn[data-status="all"].active {
            background: #6b7280;
            color: white;
            border-color: #6b7280;
        }

        .status-filter-btn[data-status="baru"].active {
            background: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .status-filter-btn[data-status="proses"].active {
            background: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }

        .status-filter-btn[data-status="selesai"].active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Summary Card */
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-top: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-item {
            text-align: center;
            flex: 1;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 700;
            color: #10b981;
        }

        .summary-label {
            font-size: 12px;
            color: #6b7280;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .export-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .export-btn:active {
            transform: scale(0.98);
        }

        .btn-word {
            background: linear-gradient(135deg, #2b5797 0%, #1e3e6e 100%);
            color: white;
        }

        .btn-excel {
            background: linear-gradient(135deg, #217346 0%, #154d2e 100%);
            color: white;
        }

        .btn-pdf {
            background: linear-gradient(135deg, #d32f2f 0%, #9a1f1f 100%);
            color: white;
        }

        /* List View */
        .list-view-container {
            margin-top: 16px;
        }

        .month-header {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin: 20px 0 12px 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .month-header i {
            margin-right: 8px;
        }

        .month-header span {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* List Item */
        .list-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 6px solid #10b981;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .list-item:active {
            transform: scale(0.98);
            background: #f0fdf4;
        }

        .list-item-left {
            flex: 1;
        }

        .list-item-title {
            font-weight: 700;
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .list-item-meta {
            display: flex;
            gap: 16px;
            color: #6b7280;
            font-size: 13px;
            flex-wrap: wrap;
        }

        .list-item-meta i {
            margin-right: 4px;
            width: 16px;
            color: #10b981;
        }

        .list-item-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .badge-baru { background: #fee2e2; color: #991b1b; }
        .badge-proses { background: #fed7aa; color: #92400e; }
        .badge-selesai { background: #dcfce7; color: #166534; }

        .list-item-arrow {
            color: #9ca3af;
            font-size: 20px;
            margin-left: 12px;
        }

        /* Status dot */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .dot-baru { background: #dc2626; }
        .dot-proses { background: #f59e0b; }
        .dot-selesai { background: #10b981; }

        /* Detail View */
        .detail-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 1000;
            overflow-y: auto;
            display: none;
        }

        .detail-header {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
        }

        .detail-title {
            font-size: 18px;
            font-weight: 600;
            flex: 1;
        }

        .detail-content {
            padding: 20px;
        }

        .detail-section {
            background: #f9fafb;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .detail-section h3 {
            color: #4b5563;
            font-size: 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .detail-section h3 i {
            color: #10b981;
        }

        .detail-row {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
        }

        .detail-label {
            width: 100px;
            color: #6b7280;
            font-size: 14px;
        }

        .detail-value {
            flex: 1;
            color: #1f2937;
            font-weight: 500;
            font-size: 15px;
        }

        .detail-photo {
            width: 100%;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
        }

        .detail-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-edit {
            background: #f3f4f6;
            color: #4b5563;
        }

        .btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .install-prompt {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            display: none;
            cursor: pointer;
        }

        /* Malaysia Corner Decoration */
        .malaysia-corner {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 30px;
            opacity: 0.3;
            z-index: 10;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .ai-corner {
            position: fixed;
            top: 10px;
            left: 10px;
            font-size: 30px;
            opacity: 0.3;
            z-index: 10;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Malaysia dan AI Decoration -->
    <div class="malaysia-corner">üá≤üáæ</div>
    <div class="ai-corner">ü§ñ</div>

    <div class="app-container">
        <div class="app-header">
            <h1>
                <i class="fas fa-leaf"></i>
                MyTek Juwaidy
            </h1>
            <p>Juwaidy Asmawi Bin Zulkefli</p>
        </div>

        <!-- Install Prompt -->
        <div class="install-prompt" id="installPrompt" onclick="installPWA()">
            <i class="fas fa-download"></i>
            Klik untuk pasang aplikasi ini pada telefon
        </div>

        <div class="content">
            <!-- Tab Navigation -->
            <div class="tab-bar">
                <div class="tab active" onclick="switchTab('form')" id="tabForm">
                    <i class="fas fa-plus-circle"></i>
                    Tugas Baru
                </div>
                <div class="tab" onclick="switchTab('list')" id="tabList">
                    <i class="fas fa-list"></i>
                    Rekod Bulanan
                </div>
            </div>

            <!-- Form Tugas Baru -->
            <div id="formSection" class="form-section">
                <form id="taskForm">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Nama Pengguna</label>
                        <input type="text" id="userName" placeholder="cth: Juwaidy Asmawi" required>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-briefcase"></i> Jenis Tugas</label>
                        <select id="taskType" required>
                            <option value="">Pilih jenis tugas</option>
                            <option value="Pemasangan">üíª Pemasangan Komputer</option>
                            <option value="Penyelenggaraan">üîß Penyelenggaraan</option>
                            <option value="Pembaikan">üõ†Ô∏è Pembaikan</option>
                            <option value="Naik Taraf">‚¨ÜÔ∏è Naik Taraf</option>
                            <option value="Rangkaian">üåê Rangkaian</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-map-marker-alt"></i> Lokasi</label>
                        <input type="text" id="location" placeholder="cth: Pejabat, Bilik Server" required>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-align-left"></i> Penerangan Tugas</label>
                        <textarea id="description" rows="3" placeholder="Terangkan tugasan..." required></textarea>
                    </div>

                    <!-- Camera Section -->
                    <div class="camera-container">
                        <h3 style="margin-bottom: 16px; color: #1f2937;">
                            <i class="fas fa-camera"></i> Dokumentasi Gambar
                        </h3>
                        
                        <div class="camera-preview">
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>
                            <img id="photoPreview" alt="Preview Gambar">
                        </div>

                        <div class="camera-controls">
                            <button type="button" class="camera-btn btn-primary" onclick="startCamera()">
                                <i class="fas fa-camera"></i> Buka Kamera
                            </button>
                            <button type="button" class="camera-btn btn-success" onclick="capturePhoto()" style="display: none;" id="captureBtn">
                                <i class="fas fa-camera-retro"></i> Ambil Gambar
                            </button>
                            <button type="button" class="camera-btn btn-danger" onclick="stopCamera()" style="display: none;" id="stopBtn">
                                <i class="fas fa-times-circle"></i> Tutup
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-tasks"></i> Status Tugas</label>
                        <select id="status" required>
                            <option value="baru">üìå Baru</option>
                            <option value="proses">‚öôÔ∏è Dalam Proses</option>
                            <option value="selesai">‚úÖ Selesai</option>
                        </select>
                    </div>

                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i>
                        Simpan Tugasan
                    </button>
                </form>
            </div>

            <!-- Senarai Tugas dengan Filter Bulanan - LIST VIEW -->
            <div id="listSection" class="list-section" style="display: none;">
                <!-- Filter Section -->
                <div class="filter-section">
                    <div class="filter-title">
                        <i class="fas fa-calendar-alt"></i>
                        PAPARAN REKOD IKUT BULAN
                    </div>
                    
                    <div class="filter-row">
                        <select id="monthFilter" class="filter-select">
                            <option value="0">Januari</option>
                            <option value="1">Februari</option>
                            <option value="2">Mac</option>
                            <option value="3">April</option>
                            <option value="4">Mei</option>
                            <option value="5">Jun</option>
                            <option value="6">Julai</option>
                            <option value="7">Ogos</option>
                            <option value="8">September</option>
                            <option value="9">Oktober</option>
                            <option value="10">November</option>
                            <option value="11">Disember</option>
                        </select>
                        
                        <select id="yearFilter" class="filter-select">
                            <!-- Tahun akan dijana automatik -->
                        </select>
                        
                        <button class="filter-btn" onclick="applyFilter()">
                            <i class="fas fa-search"></i>
                            Cari
                        </button>
                    </div>

                    <!-- Status Filter Buttons -->
                    <div class="status-filter">
                        <button class="status-filter-btn active" data-status="all" onclick="filterByStatus('all')">
                            <i class="fas fa-list"></i> Semua
                        </button>
                        <button class="status-filter-btn" data-status="baru" onclick="filterByStatus('baru')">
                            <i class="fas fa-circle"></i> Baru
                        </button>
                        <button class="status-filter-btn" data-status="proses" onclick="filterByStatus('proses')">
                            <i class="fas fa-spinner"></i> Proses
                        </button>
                        <button class="status-filter-btn" data-status="selesai" onclick="filterByStatus('selesai')">
                            <i class="fas fa-check-circle"></i> Selesai
                        </button>
                    </div>

                    <!-- Summary Card -->
                    <div class="summary-card" id="summaryCard" style="display: none;">
                        <div class="summary-item">
                            <div class="summary-value" id="totalTasks">0</div>
                            <div class="summary-label">Jumlah Tugas</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="completedTasks">0</div>
                            <div class="summary-label">Selesai</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="pendingTasks">0</div>
                            <div class="summary-label">Belum Selesai</div>
                        </div>
                    </div>
                </div>

                <!-- Export Buttons -->
                <div class="export-buttons">
                    <button class="export-btn btn-word" onclick="exportToWord()">
                        <i class="fas fa-file-word"></i>
                        Word
                    </button>
                    <button class="export-btn btn-excel" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i>
                        Excel
                    </button>
                    <button class="export-btn btn-pdf" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i>
                        PDF
                    </button>
                </div>

                <!-- LIST VIEW Container -->
                <div id="listViewContainer" class="list-view-container"></div>
            </div>
        </div>
    </div>

    <!-- DETAIL VIEW Modal -->
    <div id="detailView" class="detail-view">
        <div class="detail-header">
            <button class="back-btn" onclick="closeDetail()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="detail-title">Butiran Tugasan</div>
        </div>
        <div id="detailContent" class="detail-content">
            <!-- Content akan diisi melalui JavaScript -->
        </div>
    </div>

    <script>
        // Global variables
        let stream = null;
        let photoData = null;
        let deferredPrompt;
        let currentFilterMonth = new Date().getMonth();
        let currentFilterYear = new Date().getFullYear();
        let currentTasks = [];
        let currentStatusFilter = 'all';

        // PWA Install Handler
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        }

        // Tab switching
        function switchTab(tab) {
            const formSection = document.getElementById('formSection');
            const listSection = document.getElementById('listSection');
            const tabForm = document.getElementById('tabForm');
            const tabList = document.getElementById('tabList');

            if (tab === 'form') {
                formSection.style.display = 'block';
                listSection.style.display = 'none';
                tabForm.classList.add('active');
                tabList.classList.remove('active');
            } else {
                formSection.style.display = 'none';
                listSection.style.display = 'block';
                tabForm.classList.remove('active');
                tabList.classList.add('active');
                
                generateYearOptions();
                displayListView(currentFilterMonth, currentFilterYear);
            }
        }

        // Generate tahun (2020-2030)
        function generateYearOptions() {
            const yearSelect = document.getElementById('yearFilter');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let year = 2020; year <= 2030; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
        }

        // Camera functions
        function startCamera() {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                })
                .then(function(videoStream) {
                    stream = videoStream;
                    video.srcObject = stream;
                    video.style.display = 'block';
                    captureBtn.style.display = 'block';
                    stopBtn.style.display = 'block';
                })
                .catch(function(error) {
                    alert('Tidak boleh akses kamera: ' + error.message);
                });
            } else {
                alert('Browser tidak menyokong akses kamera');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const photoPreview = document.getElementById('photoPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            photoData = canvas.toDataURL('image/jpeg', 0.8);
            photoPreview.src = photoData;
            photoPreview.style.display = 'block';
            video.style.display = 'none';
            stopCamera();
        }

        function stopCamera() {
            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            video.style.display = 'none';
            captureBtn.style.display = 'none';
            stopBtn.style.display = 'none';
        }

        // Generate ID
        function generateId() {
            return 'TASK-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // Save task
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const now = new Date();
            const task = {
                id: generateId(),
                userName: document.getElementById('userName').value, // Tukar dari techName ke userName
                taskType: document.getElementById('taskType').value,
                location: document.getElementById('location').value,
                description: document.getElementById('description').value,
                status: document.getElementById('status').value,
                photo: photoData,
                timestamp: now.toISOString(),
                date: now.toLocaleDateString('ms-MY', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                time: now.toLocaleTimeString('ms-MY', { hour: '2-digit', minute: '2-digit' }),
                month: now.getMonth(),
                year: now.getFullYear()
            };

            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            tasks.unshift(task);
            localStorage.setItem('tasks', JSON.stringify(tasks));

            // Reset form
            this.reset();
            photoData = null;
            document.getElementById('photoPreview').style.display = 'none';
            
            alert('Tugasan berjaya disimpan!');
            switchTab('list');
            
            currentFilterMonth = now.getMonth();
            currentFilterYear = now.getFullYear();
            document.getElementById('monthFilter').value = currentFilterMonth;
            document.getElementById('yearFilter').value = currentFilterYear;
            
            displayListView(currentFilterMonth, currentFilterYear);
        });

        // Filter functions
        function applyFilter() {
            const month = parseInt(document.getElementById('monthFilter').value);
            const year = parseInt(document.getElementById('yearFilter').value);
            currentFilterMonth = month;
            currentFilterYear = year;
            displayListView(month, year);
        }

        // Filter by status
        function filterByStatus(status) {
            currentStatusFilter = status;
            
            // Update active button
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.status-filter-btn[data-status="${status}"]`).classList.add('active');
            
            displayListView(currentFilterMonth, currentFilterYear);
        }

        function getTasksByMonth(month, year) {
            const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            let filtered = tasks.filter(task => task.month === month && task.year === year);
            
            // Apply status filter
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(task => task.status === currentStatusFilter);
            }
            
            return filtered;
        }

        // LIST VIEW FUNCTION
        function displayListView(month, year) {
            const tasks = getTasksByMonth(month, year);
            currentTasks = tasks;
            const container = document.getElementById('listViewContainer');
            const summaryCard = document.getElementById('summaryCard');
            
            const monthNames = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            const monthName = monthNames[month];

            // Update summary
            if (tasks.length > 0) {
                summaryCard.style.display = 'flex';
                const total = tasks.length;
                const completed = tasks.filter(t => t.status === 'selesai').length;
                const pending = tasks.filter(t => t.status !== 'selesai').length;
                
                document.getElementById('totalTasks').textContent = total;
                document.getElementById('completedTasks').textContent = completed;
                document.getElementById('pendingTasks').textContent = pending;
            } else {
                summaryCard.style.display = 'none';
            }

            // Display LIST VIEW
            if (tasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <h3>Tiada Rekod Tugas</h3>
                        <p>Bulan ${monthName} ${year} - Tiada tugasan</p>
                    </div>
                `;
                return;
            }

            let html = `<div class="month-header">
                <span><i class="fas fa-calendar"></i> ${monthName} ${year}</span>
                <span>${tasks.length} tugasan</span>
            </div>`;

            // Display tasks in LIST VIEW
            tasks.forEach(task => {
                const statusClass = task.status === 'baru' ? 'badge-baru' : 
                                  task.status === 'proses' ? 'badge-proses' : 'badge-selesai';
                const statusText = task.status === 'baru' ? 'BARU' : 
                                  task.status === 'proses' ? 'PROSES' : 'SELESAI';
                const dotClass = task.status === 'baru' ? 'dot-baru' : 
                               task.status === 'proses' ? 'dot-proses' : 'dot-selesai';

                html += `
                    <div class="list-item" onclick="showDetail('${task.id}')">
                        <div class="list-item-left">
                            <div class="list-item-title">
                                <span class="status-dot ${dotClass}"></span>
                                ${task.taskType}
                            </div>
                            <div class="list-item-meta">
                                <span><i class="fas fa-user"></i> ${task.userName}</span>
                                <span><i class="fas fa-map-marker-alt"></i> ${task.location}</span>
                                <span><i class="fas fa-clock"></i> ${task.date}</span>
                            </div>
                        </div>
                        <div>
                            <span class="list-item-badge ${statusClass}">${statusText}</span>
                            <span class="list-item-arrow"><i class="fas fa-chevron-right"></i></span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // DETAIL VIEW FUNCTIONS
        function showDetail(taskId) {
            const task = currentTasks.find(t => t.id === taskId);
            if (!task) return;

            const detailContent = document.getElementById('detailContent');
            const statusClass = task.status === 'baru' ? 'badge-baru' : 
                              task.status === 'proses' ? 'badge-proses' : 'badge-selesai';
            const statusText = task.status === 'baru' ? 'BARU' : 
                              task.status === 'proses' ? 'DALAM PROSES' : 'SELESAI';

            detailContent.innerHTML = `
                <div class="detail-section">
                    <h3><i class="fas fa-info-circle"></i> Maklumat Tugasan</h3>
                    <div class="detail-row">
                        <div class="detail-label">ID Tugas</div>
                        <div class="detail-value">${task.id}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="list-item-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Jenis</div>
                        <div class="detail-value">${task.taskType}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Lokasi</div>
                        <div class="detail-value">${task.location}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="fas fa-user"></i> Pengguna</h3>
                    <div class="detail-row">
                        <div class="detail-label">Nama</div>
                        <div class="detail-value">${task.userName}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Tarikh</div>
                        <div class="detail-value">${task.date}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">Masa</div>
                        <div class="detail-value">${task.time || 'Tidak direkod'}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3><i class="fas fa-align-left"></i> Penerangan</h3>
                    <p style="color: #1f2937; line-height: 1.6;">${task.description}</p>
                </div>

                ${task.photo ? `
                <div class="detail-section">
                    <h3><i class="fas fa-camera"></i> Gambar</h3>
                    <img src="${task.photo}" class="detail-photo" alt="Task Photo" onclick="window.open(this.src)">
                </div>
                ` : ''}

                <div class="detail-actions">
                    <button class="action-btn btn-delete" onclick="deleteTask('${task.id}')">
                        <i class="fas fa-trash"></i> Hapus
                    </button>
                </div>
            `;

            document.getElementById('detailView').style.display = 'block';
        }

        function closeDetail() {
            document.getElementById('detailView').style.display = 'none';
        }

        function deleteTask(taskId) {
            if (confirm('Pastikan anda nak hapuskan tugasan ini?')) {
                let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                tasks = tasks.filter(t => t.id !== taskId);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                
                closeDetail();
                displayListView(currentFilterMonth, currentFilterYear);
                alert('Tugasan berjaya dihapuskan');
            }
        }

        // ===== FUNGSI EXPORT KE WORD =====
        function exportToWord() {
            const tasks = getTasksByMonth(currentFilterMonth, currentFilterYear);
            const monthNames = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            const monthName = monthNames[currentFilterMonth];
            
            if (tasks.length === 0) {
                alert('Tiada data untuk dieksport');
                return;
            }

            // Kira statistik
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'selesai').length;
            const pending = tasks.filter(t => t.status !== 'selesai').length;
            const baru = tasks.filter(t => t.status === 'baru').length;
            const proses = tasks.filter(t => t.status === 'proses').length;

            // Hasilkan HTML untuk Word
            let htmlContent = `
                <html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:m="http://schemas.microsoft.com/office/2004/12/omml" xmlns="http://www.w3.org/TR/REC-html40">
                <head>
                    <meta charset="UTF-8">
                    <title>Laporan Tugasan Bulanan</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 30px; }
                        h1 { color: #047857; border-bottom: 3px solid #10b981; padding-bottom: 10px; }
                        h2 { color: #065f46; margin-top: 25px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #10b981; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border-bottom: 1px solid #ddd; }
                        tr:hover { background: #f5f5f5; }
                        .summary { 
                            background: #f0fdf4; 
                            padding: 15px; 
                            border-radius: 10px; 
                            margin: 20px 0;
                            border-left: 6px solid #10b981;
                        }
                        .summary p { margin: 8px 0; font-size: 16px; }
                        .footer { margin-top: 40px; font-size: 12px; color: #666; text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>LAPORAN TUGASAN PENGGUNA</h1>
                    <p><strong>Nama:</strong> Juwaidy Asmawi Bin Zulkefli</p>
                    <p><strong>Bulan:</strong> ${monthName} ${currentFilterYear}</p>
                    <p><strong>Tarikh Dijana:</strong> ${new Date().toLocaleDateString('ms-MY')} ${new Date().toLocaleTimeString('ms-MY')}</p>
                    
                    <div class="summary">
                        <h3>RINGKASAN</h3>
                        <p><strong>Jumlah Tugasan:</strong> ${total}</p>
                        <p><strong>Selesai:</strong> ${completed}</p>
                        <p><strong>Dalam Proses:</strong> ${proses}</p>
                        <p><strong>Baru:</strong> ${baru}</p>
                        <p><strong>Kadar Siap:</strong> ${((completed/total)*100).toFixed(1)}%</p>
                    </div>

                    <h2>SENARAI TUGASAN</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Bil</th>
                                <th>Tarikh</th>
                                <th>Jenis Tugas</th>
                                <th>Nama Pengguna</th>
                                <th>Lokasi</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            tasks.forEach((task, index) => {
                const statusText = task.status === 'baru' ? 'BARU' : 
                                  task.status === 'proses' ? 'PROSES' : 'SELESAI';
                
                htmlContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${task.date}</td>
                        <td>${task.taskType}</td>
                        <td>${task.userName}</td>
                        <td>${task.location}</td>
                        <td>${statusText}</td>
                    </tr>
                `;
            });

            htmlContent += `
                        </tbody>
                    </table>
                    
                    <h2 style="margin-top: 30px;">BUTIRAN LENGKAP</h2>
            `;

            tasks.forEach((task, index) => {
                const statusText = task.status === 'baru' ? 'BARU' : 
                                  task.status === 'proses' ? 'PROSES' : 'SELESAI';
                
                htmlContent += `
                    <div style="background: #f9fafb; padding: 15px; margin: 15px 0; border-radius: 8px;">
                        <h3>Tugasan #${index + 1}</h3>
                        <p><strong>ID:</strong> ${task.id}</p>
                        <p><strong>Jenis:</strong> ${task.taskType}</p>
                        <p><strong>Nama Pengguna:</strong> ${task.userName}</p>
                        <p><strong>Lokasi:</strong> ${task.location}</p>
                        <p><strong>Tarikh:</strong> ${task.date}</p>
                        <p><strong>Status:</strong> ${statusText}</p>
                        <p><strong>Penerangan:</strong> ${task.description}</p>
                        ${task.photo ? `<p><strong>Gambar:</strong> [Gambar telah diambil]</p>` : ''}
                    </div>
                `;
            });

            htmlContent += `
                    <div class="footer">
                        <p>Laporan ini dijana secara automatik oleh MyTek Juwaidy</p>
                        <p>¬© ${new Date().getFullYear()} - Juwaidy Asmawi Bin Zulkefli</p>
                    </div>
                </body>
                </html>
            `;

            // Buat blob dan download sebagai .doc
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const fileName = `Laporan_Tugasan_${monthName}_${currentFilterYear}.doc`;
            saveAs(blob, fileName);
            
            alert(`Laporan ${monthName} ${currentFilterYear} telah dieksport ke Word`);
        }

        // ===== FUNGSI EXPORT KE EXCEL (CSV) =====
        function exportToExcel() {
            const tasks = getTasksByMonth(currentFilterMonth, currentFilterYear);
            const monthNames = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            const monthName = monthNames[currentFilterMonth];
            
            if (tasks.length === 0) {
                alert('Tiada data untuk dieksport');
                return;
            }

            // Buat header CSV
            let csv = "Bil,Tarikh,Jenis Tugas,Nama Pengguna,Lokasi,Status,Penerangan\n";
            
            tasks.forEach((task, index) => {
                const statusText = task.status === 'baru' ? 'BARU' : 
                                  task.status === 'proses' ? 'PROSES' : 'SELESAI';
                
                // Escape koma dalam description
                const description = task.description.replace(/,/g, ';');
                
                csv += `${index + 1},${task.date},${task.taskType},${task.userName},${task.location},${statusText},"${description}"\n`;
            });

            // Buat blob dan download
            const blob = new Blob([csv], { type: 'text/csv' });
            const fileName = `Laporan_Tugasan_${monthName}_${currentFilterYear}.csv`;
            saveAs(blob, fileName);
            
            alert(`Laporan ${monthName} ${currentFilterYear} telah dieksport ke Excel (CSV)`);
        }

        // ===== FUNGSI EXPORT KE PDF =====
        function exportToPDF() {
            const tasks = getTasksByMonth(currentFilterMonth, currentFilterYear);
            const monthNames = ['Januari', 'Februari', 'Mac', 'April', 'Mei', 'Jun', 'Julai', 'Ogos', 'September', 'Oktober', 'November', 'Disember'];
            const monthName = monthNames[currentFilterMonth];
            
            if (tasks.length === 0) {
                alert('Tiada data untuk dieksport');
                return;
            }

            // Kira statistik
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'selesai').length;
            const pending = tasks.filter(t => t.status !== 'selesai').length;

            // Hasilkan HTML untuk PDF
            let htmlContent = `
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Laporan Tugasan Bulanan</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 30px; }
                        h1 { color: #047857; border-bottom: 2px solid #047857; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #047857; color: white; padding: 8px; text-align: left; }
                        td { padding: 8px; border: 1px solid #ddd; }
                        .summary { background: #f0fdf4; padding: 10px; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    <h1>LAPORAN TUGASAN PENGGUNA</h1>
                    <p><strong>Nama:</strong> Juwaidy Asmawi Bin Zulkefli</p>
                    <p><strong>Bulan:</strong> ${monthName} ${currentFilterYear}</p>
                    
                    <div class="summary">
                        <h3>RINGKASAN</h3>
                        <p>Jumlah Tugasan: ${total}</p>
                        <p>Selesai: ${completed}</p>
                        <p>Belum Selesai: ${pending}</p>
                    </div>

                    <h2>SENARAI TUGASAN</h2>
                    <table>
                        <tr>
                            <th>Bil</th>
                            <th>Tarikh</th>
                            <th>Jenis</th>
                            <th>Nama Pengguna</th>
                            <th>Lokasi</th>
                            <th>Status</th>
                        </tr>
            `;

            tasks.forEach((task, index) => {
                const statusText = task.status === 'baru' ? 'BARU' : 
                                  task.status === 'proses' ? 'PROSES' : 'SELESAI';
                
                htmlContent += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${task.date}</td>
                        <td>${task.taskType}</td>
                        <td>${task.userName}</td>
                        <td>${task.location}</td>
                        <td>${statusText}</td>
                    </tr>
                `;
            });

            htmlContent += `
                    </table>
                    <p style="margin-top: 40px; font-size: 12px;">Dijana pada: ${new Date().toLocaleString('ms-MY')}</p>
                </body>
                </html>
            `;

            // Buka dalam tab baru, user boleh print sebagai PDF
            const newWindow = window.open('', '_blank');
            newWindow.document.write(htmlContent);
            newWindow.document.close();
            newWindow.print();
        }

        // Initialize
        window.onload = function() {
            generateYearOptions();
            const today = new Date();
            document.getElementById('monthFilter').value = today.getMonth();
            document.getElementById('yearFilter').value = today.getFullYear();
            
            // Set default status filter to 'all'
            filterByStatus('all');
        };
    </script>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker failed'));
    }
</script>
<script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registered: ', registration);
                })
                .catch(function(error) {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }
</script>
</body>
</html>